syntax = "proto3";

package portfoliodb.ingestion.v1;

import "google/protobuf/timestamp.proto";
import "portfoliodb/api/v1/api.proto";

option go_package = "portfoliodb/ingestion/v1;ingestionv1";

// IngestionService provides gRPC endpoints for uploading transaction data
// (bulk and single).
service IngestionService {
  // UpsertTxs replaces all transactions for the given broker in the given
  // period with the supplied list. Processed asynchronously; returns a job_id
  // for status and validation errors via the front-end API.
  rpc UpsertTxs(UpsertTxsRequest) returns (IngestionResponse);
  // UpsertTx creates or replaces one transaction by natural key
  // (timestamp, broker, instrument_description). Idempotent. Processed
  // asynchronously; returns a job_id for status.
  rpc UpsertTx(UpsertTxRequest) returns (IngestionResponse);
}

// UpsertTxsRequest replaces all transactions for the given broker in the
// given period with the supplied list. User from auth; portfolio must be
// owned by that user.
message UpsertTxsRequest {
  // Portfolio to ingest into. Must be owned by the authenticated user.
  string portfolio_id = 1;
  // Broker. All transactions in this request are for this broker.
  portfoliodb.api.v1.Broker broker = 2;
  // Period of transactions covered. Only transactions in this range for this
  // broker are replaced; others are unchanged.
  google.protobuf.Timestamp period_from = 3;
  google.protobuf.Timestamp period_to   = 4;
  // Transactions to store. Replaces any existing tx in [period_from, period_to]
  // for this broker.
  repeated portfoliodb.api.v1.Tx txs = 5;
}

// UpsertTxRequest creates or replaces one transaction by natural key.
message UpsertTxRequest {
  // Portfolio to ingest into. Must be owned by the authenticated user.
  string portfolio_id = 1;
  // Broker for this transaction.
  portfoliodb.api.v1.Broker broker = 2;
  // The transaction.
  portfoliodb.api.v1.Tx tx = 3;
}

// IngestionResponse returned by UpsertTxs and UpsertTx. Job status and
// validation errors are available via the front-end/back-end API using job_id.
message IngestionResponse {
  // Identifier for the async ingestion job. Use with front-end API to poll
  // status and retrieve validation errors.
  string job_id = 1;
}
